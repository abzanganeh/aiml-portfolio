{% extends "base.html" %}

{% block title %}Interactive Data Preprocessing - Machine Learning Tutorial{% endblock %}

{% block description %}Master data preprocessing through hands-on practice with missing values, outliers, and feature scaling techniques.{% endblock %}

{% block content %}
<div class="main-content">
    <div class="container">
        <!-- Header Section -->
        <section class="tutorial-header">
            <h1><i class="fas fa-broom text-primary"></i> Interactive Data Preprocessing</h1>
            <p class="lead">Learn essential data cleaning and preparation techniques through hands-on practice</p>
            <div class="tutorial-meta">
                <span class="badge badge-primary"><i class="fas fa-clock"></i> 20 minutes</span>
                <span class="badge badge-success"><i class="fas fa-chart-line"></i> Beginner</span>
                <span class="badge badge-warning"><i class="fas fa-code"></i> Python</span>
            </div>
        </section>

        <!-- Introduction -->
        <section class="tutorial-section">
            <h2>Why Data Preprocessing?</h2>
            <div class="concept-box">
                <p><strong>Data Preprocessing</strong> is the foundation of successful machine learning. Real-world data is messy, incomplete, and often inconsistent. This tutorial teaches you to handle these challenges.</p>
                
                <div class="key-points">
                    <h4>What You'll Learn:</h4>
                    <ul>
                        <li><strong>Missing Values:</strong> Detect and handle missing data</li>
                        <li><strong>Outlier Detection:</strong> Identify and treat extreme values</li>
                        <li><strong>Feature Scaling:</strong> Normalize data for better model performance</li>
                        <li><strong>Data Quality:</strong> Assess and improve data quality</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Interactive Dataset -->
        <section class="tutorial-section">
            <h2>Sample Dataset: Employee Salaries</h2>
            <p>Let's work with an employee dataset that has common data quality issues:</p>
            
            <div class="data-container">
                <div class="data-controls">
                    <button id="load-data-btn" class="btn btn-primary">
                        <i class="fas fa-database"></i> Load Sample Data
                    </button>
                    <button id="show-summary-btn" class="btn btn-secondary" disabled>
                        <i class="fas fa-chart-bar"></i> Show Summary
                    </button>
                </div>
                
                <div id="dataset-display" class="data-display">
                    <p class="text-muted">Click "Load Sample Data" to begin exploring!</p>
                </div>
            </div>
        </section>

        <!-- Missing Values Section -->
        <section class="tutorial-section">
            <h2><i class="fas fa-question-circle"></i> Handling Missing Values</h2>
            
            <div class="technique-card">
                <h3>Step 1: Detect Missing Values</h3>
                <p>First, let's identify where we have missing data in our dataset.</p>
                
                <div class="interactive-demo">
                    <button id="detect-missing-btn" class="btn btn-info" disabled>
                        <i class="fas fa-search"></i> Detect Missing Values
                    </button>
                    <div id="missing-analysis" class="result-display"></div>
                </div>
            </div>

                            <div class="technique-card">
                    <h3>Step 2: Choose Strategy</h3>
                    <p>Select how to handle missing values based on the data pattern.</p>
                    
                    <div class="interactive-demo">
                        <div class="demo-controls">
                            <label for="missing-strategy">Missing Value Strategy:</label>
                            <select id="missing-strategy" class="form-control" disabled>
                                <option value="">Select strategy</option>
                                <option value="drop">Drop rows with missing values</option>
                                <option value="mean">Fill with mean (numeric)</option>
                                <option value="mode">Fill with mode (categorical)</option>
                                <option value="median">Fill with median (numeric)</option>
                            </select>
                            <button id="apply-missing-btn" class="btn btn-success mt-2" disabled>
                                <i class="fas fa-tools"></i> Apply Strategy
                            </button>
                        </div>
                        <div id="missing-result" class="result-display"></div>
                    </div>
                </div>

                <!-- Outlier Detection Section -->
                <div class="technique-card">
                    <h3>Step 3: Detect Outliers</h3>
                    <p>Identify extreme values that might affect your model performance.</p>
                    
                    <div class="interactive-demo">
                        <button id="detect-outliers-btn" class="btn btn-info" disabled>
                            <i class="fas fa-search"></i> Detect Outliers
                        </button>
                        <div id="outlier-analysis" class="result-display"></div>
                    </div>
                </div>

                <!-- Feature Scaling Section -->
                <div class="technique-card">
                    <h3>Step 4: Scale Features</h3>
                    <p>Normalize your data for better model performance.</p>
                    
                    <div class="interactive-demo">
                        <div class="demo-controls">
                            <label for="scaling-method">Scaling Method:</label>
                            <select id="scaling-method" class="form-control" disabled>
                                <option value="">Select method</option>
                                <option value="minmax">Min-Max Scaling (0-1)</option>
                                <option value="standard">Standard Scaling (z-score)</option>
                                <option value="robust">Robust Scaling (median-based)</option>
                            </select>
                            <button id="apply-scaling-btn" class="btn btn-success mt-2" disabled>
                                <i class="fas fa-tools"></i> Apply Scaling
                            </button>
                        </div>
                        <div id="scaling-result" class="result-display"></div>
                    </div>
                </div>
            </section>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
<style>
.tutorial-header {
    text-align: center;
    padding: 2rem 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    margin-bottom: 2rem;
    border-radius: 1rem;
}

.tutorial-meta .badge {
    margin: 0 0.5rem;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

.concept-box {
    background: #f8f9fa;
    border-left: 4px solid #007bff;
    padding: 1.5rem;
    margin: 1rem 0;
    border-radius: 0.5rem;
}

.technique-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 1rem;
    padding: 2rem;
    margin: 2rem 0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.interactive-demo {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-top: 1rem;
}

.result-display {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    min-height: 80px;
    margin-top: 1rem;
}

.data-container {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 1rem;
    padding: 2rem;
    margin: 1rem 0;
}

.data-display {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1rem;
    min-height: 200px;
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
}

table th, table td {
    border: 1px solid #dee2e6;
    padding: 0.75rem;
    text-align: left;
}

table th {
    background: #f8f9fa;
    font-weight: 600;
}

.missing-value {
    background: #fff3cd;
    color: #856404;
    font-style: italic;
}

.outlier-value {
    background: #f8d7da;
    color: #721c24;
    font-weight: bold;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Sample employee dataset with common data issues
const originalData = [
    {id: 1, name: 'Alice Johnson', age: 28, department: 'Engineering', salary: 75000, experience: 3},
    {id: 2, name: 'Bob Smith', age: null, department: 'Marketing', salary: 65000, experience: 5},
    {id: 3, name: 'Carol Davis', age: 35, department: 'Engineering', salary: null, experience: 8},
    {id: 4, name: 'David Brown', age: 42, department: null, salary: 95000, experience: 15},
    {id: 5, name: 'Eve Wilson', age: 29, department: 'Sales', salary: 55000, experience: 2},
    {id: 6, name: 'Frank Miller', age: 55, department: 'Engineering', salary: 120000, experience: 25},
    {id: 7, name: 'Grace Lee', age: 31, department: 'Marketing', salary: 70000, experience: null},
    {id: 8, name: 'Henry Taylor', age: 38, department: 'Sales', salary: 250000, experience: 12}, // Outlier salary
    {id: 9, name: 'Ivy Chen', age: null, department: 'Engineering', salary: 80000, experience: 6},
    {id: 10, name: 'Jack White', age: 26, department: 'Sales', salary: 50000, experience: 1}
];

let currentData = [];
let processedData = [];

document.addEventListener('DOMContentLoaded', function() {
    initializeEventListeners();
});

function initializeEventListeners() {
    document.getElementById('load-data-btn').addEventListener('click', loadSampleData);
    document.getElementById('show-summary-btn').addEventListener('click', showDataSummary);
    document.getElementById('detect-missing-btn').addEventListener('click', detectMissingValues);
    document.getElementById('missing-strategy').addEventListener('change', enableMissingButton);
    document.getElementById('apply-missing-btn').addEventListener('click', applyMissingStrategy);
    document.getElementById('detect-outliers-btn').addEventListener('click', detectOutliers);
    document.getElementById('scaling-method').addEventListener('change', enableScalingButton);
    document.getElementById('apply-scaling-btn').addEventListener('click', applyScaling);
}

function loadSampleData() {
    currentData = JSON.parse(JSON.stringify(originalData));
    processedData = [...currentData];
    displayDataTable();
    
    // Enable buttons
    document.getElementById('show-summary-btn').disabled = false;
    document.getElementById('detect-missing-btn').disabled = false;
    document.getElementById('missing-strategy').disabled = false;
    document.getElementById('detect-outliers-btn').disabled = false;
    document.getElementById('scaling-method').disabled = false;
    
    document.getElementById('load-data-btn').innerHTML = '<i class="fas fa-sync-alt"></i> Reload Data';
}

function displayDataTable() {
    const display = document.getElementById('dataset-display');
    let html = '<h4>Employee Dataset</h4>';
    html += '<table><thead><tr>';
    
    // Headers
    const headers = Object.keys(currentData[0]);
    headers.forEach(header => {
        html += `<th>${header.toUpperCase()}</th>`;
    });
    html += '</tr></thead><tbody>';
    
    // Rows
    currentData.forEach(row => {
        html += '<tr>';
        headers.forEach(header => {
            let value = row[header];
            let className = '';
            
            if (value === null || value === undefined) {
                value = 'NULL';
                className = 'missing-value';
            } else if (header === 'salary' && value > 200000) {
                className = 'outlier-value';
            }
            
            html += `<td class="${className}">${value}</td>`;
        });
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    html += '<p><small><span class="missing-value">Yellow</span> = Missing values, <span class="outlier-value">Red</span> = Potential outliers</small></p>';
    display.innerHTML = html;
}

function showDataSummary() {
    const display = document.getElementById('dataset-display');
    const totalRows = currentData.length;
    const columns = Object.keys(currentData[0]);
    
    let html = '<h4>Dataset Summary</h4>';
    html += '<div class="summary-grid">';
    html += `<p><strong>Total Rows:</strong> ${totalRows}</p>`;
    html += `<p><strong>Total Columns:</strong> ${columns.length}</p>`;
    
    // Missing value counts
    html += '<h5>Missing Values by Column:</h5><ul>';
    columns.forEach(col => {
        const missingCount = currentData.filter(row => row[col] === null || row[col] === undefined).length;
        const percentage = ((missingCount / totalRows) * 100).toFixed(1);
        html += `<li><strong>${col}:</strong> ${missingCount} (${percentage}%)</li>`;
    });
    html += '</ul>';
    
    // Data types
    html += '<h5>Column Data Types:</h5><ul>';
    columns.forEach(col => {
        const firstNonNull = currentData.find(row => row[col] !== null && row[col] !== undefined);
        const type = firstNonNull ? typeof firstNonNull[col] : 'unknown';
        html += `<li><strong>${col}:</strong> ${type}</li>`;
    });
    html += '</ul>';
    
    html += '</div>';
    html += '<button onclick="displayDataTable()" class="btn btn-secondary mt-2">Back to Data</button>';
    display.innerHTML = html;
}

function detectMissingValues() {
    const resultDiv = document.getElementById('missing-analysis');
    const totalRows = currentData.length;
    const columns = Object.keys(currentData[0]);
    
    let html = '<h5><i class="fas fa-exclamation-triangle"></i> Missing Value Analysis</h5>';
    html += '<div class="missing-summary">';
    
    let hasMissing = false;
    columns.forEach(col => {
        const missingRows = currentData.map((row, index) => ({index, missing: row[col] === null || row[col] === undefined}))
                                      .filter(item => item.missing);
        
        if (missingRows.length > 0) {
            hasMissing = true;
            const percentage = ((missingRows.length / totalRows) * 100).toFixed(1);
            html += `<div class="missing-column">`;
            html += `<p><strong>${col}:</strong> ${missingRows.length} missing values (${percentage}%)</p>`;
            html += `<p><small>Missing in rows: ${missingRows.map(r => r.index + 1).join(', ')}</small></p>`;
            html += `</div>`;
        }
    });
    
    if (!hasMissing) {
        html += '<p class="text-success"><i class="fas fa-check"></i> No missing values found in the dataset!</p>';
    }
    
    html += '</div>';
    resultDiv.innerHTML = html;
}

function enableMissingButton() {
    const strategy = document.getElementById('missing-strategy').value;
    const button = document.getElementById('apply-missing-btn');
    button.disabled = !strategy;
}

function applyMissingStrategy() {
    const strategy = document.getElementById('missing-strategy').value;
    const resultDiv = document.getElementById('missing-result');
    
    let newData = JSON.parse(JSON.stringify(currentData));
    let description = '';
    let rowsAffected = 0;
    
    switch(strategy) {
        case 'drop':
            const originalLength = newData.length;
            newData = newData.filter(row => {
                return Object.values(row).every(val => val !== null && val !== undefined);
            });
            rowsAffected = originalLength - newData.length;
            description = `Dropped ${rowsAffected} rows with missing values`;
            break;
            
        case 'mean':
            const numericColumns = ['age', 'salary', 'experience'];
            numericColumns.forEach(col => {
                const values = newData.filter(row => row[col] !== null && row[col] !== undefined).map(row => row[col]);
                if (values.length > 0) {
                    const mean = Math.round(values.reduce((a, b) => a + b, 0) / values.length);
                    newData.forEach(row => {
                        if (row[col] === null || row[col] === undefined) {
                            row[col] = mean;
                            rowsAffected++;
                        }
                    });
                }
            });
            description = `Filled ${rowsAffected} missing numeric values with column means`;
            break;
            
        case 'mode':
            const categoricalColumns = ['department'];
            categoricalColumns.forEach(col => {
                const values = newData.filter(row => row[col] !== null && row[col] !== undefined).map(row => row[col]);
                if (values.length > 0) {
                    // Find mode (most frequent value)
                    const frequency = {};
                    values.forEach(val => frequency[val] = (frequency[val] || 0) + 1);
                    const mode = Object.keys(frequency).reduce((a, b) => frequency[a] > frequency[b] ? a : b);
                    
                    newData.forEach(row => {
                        if (row[col] === null || row[col] === undefined) {
                            row[col] = mode;
                            rowsAffected++;
                        }
                    });
                }
            });
            description = `Filled ${rowsAffected} missing categorical values with column modes`;
            break;
            
        case 'median':
            const numCols = ['age', 'salary', 'experience'];
            numCols.forEach(col => {
                const values = newData.filter(row => row[col] !== null && row[col] !== undefined)
                                   .map(row => row[col])
                                   .sort((a, b) => a - b);
                if (values.length > 0) {
                    const median = values[Math.floor(values.length / 2)];
                    newData.forEach(row => {
                        if (row[col] === null || row[col] === undefined) {
                            row[col] = median;
                            rowsAffected++;
                        }
                    });
                }
            });
            description = `Filled ${rowsAffected} missing numeric values with column medians`;
            break;
    }
    
    currentData = newData;
    
    resultDiv.innerHTML = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle"></i> Strategy Applied Successfully</h6>
            <p><strong>Action:</strong> ${description}</p>
            <p><strong>Dataset Size:</strong> ${newData.length} rows</p>
            <button onclick="displayDataTable()" class="btn btn-primary btn-sm">View Updated Data</button>
        </div>
    `;
}

function detectOutliers() {
    const resultDiv = document.getElementById('outlier-analysis');
    const numericColumns = ['age', 'salary', 'experience'];
    
    let html = '<h5><i class="fas fa-exclamation-triangle"></i> Outlier Detection Results</h5>';
    html += '<div class="outlier-summary">';
    
    let hasOutliers = false;
    numericColumns.forEach(col => {
        const values = currentData.filter(row => row[col] !== null && row[col] !== undefined).map(row => row[col]);
        if (values.length > 0) {
            // Calculate IQR
            const sorted = values.sort((a, b) => a - b);
            const q1 = sorted[Math.floor(sorted.length * 0.25)];
            const q3 = sorted[Math.floor(sorted.length * 0.75)];
            const iqr = q3 - q1;
            const lowerBound = q1 - 1.5 * iqr;
            const upperBound = q3 + 1.5 * iqr;
            
            const outliers = currentData.filter(row => {
                const val = row[col];
                return val !== null && val !== undefined && (val < lowerBound || val > upperBound);
            });
            
            if (outliers.length > 0) {
                hasOutliers = true;
                html += `<div class="outlier-column">`;
                html += `<p><strong>${col}:</strong> ${outliers.length} outliers detected</p>`;
                html += `<p><small>Range: ${lowerBound.toFixed(2)} - ${upperBound.toFixed(2)}</small></p>`;
                html += `<p><small>Outlier values: ${outliers.map(r => r[col]).join(', ')}</small></p>`;
                html += `</div>`;
            }
        }
    });
    
    if (!hasOutliers) {
        html += '<p class="text-success"><i class="fas fa-check"></i> No significant outliers detected using IQR method!</p>';
    }
    
    html += '</div>';
    resultDiv.innerHTML = html;
}

function enableScalingButton() {
    const method = document.getElementById('scaling-method').value;
    const button = document.getElementById('apply-scaling-btn');
    button.disabled = !method;
}

function applyScaling() {
    const method = document.getElementById('scaling-method').value;
    const resultDiv = document.getElementById('scaling-result');
    
    let newData = JSON.parse(JSON.stringify(currentData));
    let description = '';
    
    const numericColumns = ['age', 'salary', 'experience'];
    
    switch(method) {
        case 'minmax':
            numericColumns.forEach(col => {
                const values = newData.filter(row => row[col] !== null && row[col] !== undefined).map(row => row[col]);
                if (values.length > 0) {
                    const min = Math.min(...values);
                    const max = Math.max(...values);
                    const range = max - min;
                    
                    if (range > 0) {
                        newData.forEach(row => {
                            if (row[col] !== null && row[col] !== undefined) {
                                row[col] = Number(((row[col] - min) / range).toFixed(3));
                            }
                        });
                    }
                }
            });
            description = 'Applied Min-Max scaling (0-1 range)';
            break;
            
        case 'standard':
            numericColumns.forEach(col => {
                const values = newData.filter(row => row[col] !== null && row[col] !== undefined).map(row => row[col]);
                if (values.length > 0) {
                    const mean = values.reduce((a, b) => a + b, 0) / values.length;
                    const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length;
                    const std = Math.sqrt(variance);
                    
                    if (std > 0) {
                        newData.forEach(row => {
                            if (row[col] !== null && row[col] !== undefined) {
                                row[col] = Number(((row[col] - mean) / std).toFixed(3));
                            }
                        });
                    }
                }
            });
            description = 'Applied Standard scaling (z-score normalization)';
            break;
            
        case 'robust':
            numericColumns.forEach(col => {
                const values = newData.filter(row => row[col] !== null && row[col] !== undefined).map(row => row[col]);
                if (values.length > 0) {
                    const sorted = values.sort((a, b) => a - b);
                    const median = sorted[Math.floor(sorted.length / 2)];
                    const q1 = sorted[Math.floor(sorted.length * 0.25)];
                    const q3 = sorted[Math.floor(sorted.length * 0.75)];
                    const iqr = q3 - q1;
                    
                    if (iqr > 0) {
                        newData.forEach(row => {
                            if (row[col] !== null && row[col] !== undefined) {
                                row[col] = Number(((row[col] - median) / iqr).toFixed(3));
                            }
                        });
                    }
                }
            });
            description = 'Applied Robust scaling (median and IQR based)';
            break;
    }
    
    currentData = newData;
    
    resultDiv.innerHTML = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle"></i> Feature Scaling Applied</h6>
            <p><strong>Method:</strong> ${description}</p>
            <p><strong>Columns Scaled:</strong> ${numericColumns.join(', ')}</p>
            <button onclick="displayDataTable()" class="btn btn-primary btn-sm">View Scaled Data</button>
        </div>
    `;
}
        </section>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.tutorial-header {
    text-align: center;
    padding: 2rem 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    margin-bottom: 2rem;
    border-radius: 1rem;
}

.tutorial-meta .badge {
    margin: 0 0.5rem;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

.concept-box {
    background: #f8f9fa;
    border-left: 4px solid #007bff;
    padding: 1.5rem;
    margin: 1rem 0;
    border-radius: 0.5rem;
}

.technique-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 1rem;
    padding: 2rem;
    margin: 2rem 0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.interactive-demo {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-top: 1rem;
}

.result-display {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    min-height: 80px;
    margin-top: 1rem;
}

.data-container {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 1rem;
    padding: 2rem;
    margin: 1rem 0;
}

.data-display {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1rem;
    min-height: 200px;
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
}

table th, table td {
    border: 1px solid #dee2e6;
    padding: 0.75rem;
    text-align: left;
}

table th {
    background: #f8f9fa;
    font-weight: 600;
}

.missing-value {
    background: #fff3cd;
    color: #856404;
    font-style: italic;
}

.outlier-value {
    background: #f8d7da;
    color: #721c24;
    font-weight: bold;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Sample employee dataset with common data issues
const originalData = [
    {id: 1, name: 'Alice Johnson', age: 28, department: 'Engineering', salary: 75000, experience: 3},
    {id: 2, name: 'Bob Smith', age: null, department: 'Marketing', salary: 65000, experience: 5},
    {id: 3, name: 'Carol Davis', age: 35, department: 'Engineering', salary: null, experience: 8},
    {id: 4, name: 'David Brown', age: 42, department: null, salary: 95000, experience: 15},
    {id: 5, name: 'Eve Wilson', age: 29, department: 'Sales', salary: 55000, experience: 2},
    {id: 6, name: 'Frank Miller', age: 55, department: 'Engineering', salary: 120000, experience: 25},
    {id: 7, name: 'Grace Lee', age: 31, department: 'Marketing', salary: 70000, experience: null},
    {id: 8, name: 'Henry Taylor', age: 38, department: 'Sales', salary: 250000, experience: 12}, // Outlier salary
    {id: 9, name: 'Ivy Chen', age: null, department: 'Engineering', salary: 80000, experience: 6},
    {id: 10, name: 'Jack White', age: 26, department: 'Sales', salary: 50000, experience: 1}
];

let currentData = [];
let processedData = [];

document.addEventListener('DOMContentLoaded', function() {
    initializeEventListeners();
});

function initializeEventListeners() {
    document.getElementById('load-data-btn').addEventListener('click', loadSampleData);
    document.getElementById('show-summary-btn').addEventListener('click', showDataSummary);
    document.getElementById('detect-missing-btn').addEventListener('click', detectMissingValues);
    document.getElementById('missing-strategy').addEventListener('change', enableMissingButton);
    document.getElementById('apply-missing-btn').addEventListener('click', applyMissingStrategy);
}

function loadSampleData() {
    currentData = JSON.parse(JSON.stringify(originalData));
    processedData = [...currentData];
    displayDataTable();
    
    // Enable buttons
    document.getElementById('show-summary-btn').disabled = false;
    document.getElementById('detect-missing-btn').disabled = false;
    document.getElementById('missing-strategy').disabled = false;
    
    document.getElementById('load-data-btn').innerHTML = '<i class="fas fa-sync-alt"></i> Reload Data';
}

function displayDataTable() {
    const display = document.getElementById('dataset-display');
    let html = '<h4>Employee Dataset</h4>';
    html += '<table><thead><tr>';
    
    // Headers
    const headers = Object.keys(currentData[0]);
    headers.forEach(header => {
        html += `<th>${header.toUpperCase()}</th>`;
    });
    html += '</tr></thead><tbody>';
    
    // Rows
    currentData.forEach(row => {
        html += '<tr>';
        headers.forEach(header => {
            let value = row[header];
            let className = '';
            
            if (value === null || value === undefined) {
                value = 'NULL';
                className = 'missing-value';
            } else if (header === 'salary' && value > 200000) {
                className = 'outlier-value';
            }
            
            html += `<td class="${className}">${value}</td>`;
        });
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    html += '<p><small><span class="missing-value">Yellow</span> = Missing values, <span class="outlier-value">Red</span> = Potential outliers</small></p>';
    display.innerHTML = html;
}

function showDataSummary() {
    const display = document.getElementById('dataset-display');
    const totalRows = currentData.length;
    const columns = Object.keys(currentData[0]);
    
    let html = '<h4>Dataset Summary</h4>';
    html += '<div class="summary-grid">';
    html += `<p><strong>Total Rows:</strong> ${totalRows}</p>`;
    html += `<p><strong>Total Columns:</strong> ${columns.length}</p>`;
    
    // Missing value counts
    html += '<h5>Missing Values by Column:</h5><ul>';
    columns.forEach(col => {
        const missingCount = currentData.filter(row => row[col] === null || row[col] === undefined).length;
        const percentage = ((missingCount / totalRows) * 100).toFixed(1);
        html += `<li><strong>${col}:</strong> ${missingCount} (${percentage}%)</li>`;
    });
    html += '</ul>';
    
    // Data types
    html += '<h5>Column Data Types:</h5><ul>';
    columns.forEach(col => {
        const firstNonNull = currentData.find(row => row[col] !== null && row[col] !== undefined);
        const type = firstNonNull ? typeof firstNonNull[col] : 'unknown';
        html += `<li><strong>${col}:</strong> ${type}</li>`;
    });
    html += '</ul>';
    
    html += '</div>';
    html += '<button onclick="displayDataTable()" class="btn btn-secondary mt-2">Back to Data</button>';
    display.innerHTML = html;
}

function detectMissingValues() {
    const resultDiv = document.getElementById('missing-analysis');
    const totalRows = currentData.length;
    const columns = Object.keys(currentData[0]);
    
    let html = '<h5><i class="fas fa-exclamation-triangle"></i> Missing Value Analysis</h5>';
    html += '<div class="missing-summary">';
    
    let hasMissing = false;
    columns.forEach(col => {
        const missingRows = currentData.map((row, index) => ({index, missing: row[col] === null || row[col] === undefined}))
                                      .filter(item => item.missing);
        
        if (missingRows.length > 0) {
            hasMissing = true;
            const percentage = ((missingRows.length / totalRows) * 100).toFixed(1);
            html += `<div class="missing-column">`;
            html += `<p><strong>${col}:</strong> ${missingRows.length} missing values (${percentage}%)</p>`;
            html += `<p><small>Missing in rows: ${missingRows.map(r => r.index + 1).join(', ')}</small></p>`;
            html += `</div>`;
        }
    });
    
    if (!hasMissing) {
        html += '<p class="text-success"><i class="fas fa-check"></i> No missing values found in the dataset!</p>';
    }
    
    html += '</div>';
    resultDiv.innerHTML = html;
}

function enableMissingButton() {
    const strategy = document.getElementById('missing-strategy').value;
    const button = document.getElementById('apply-missing-btn');
    button.disabled = !strategy;
}

function applyMissingStrategy() {
    const strategy = document.getElementById('missing-strategy').value;
    const resultDiv = document.getElementById('missing-result');
    
    let newData = JSON.parse(JSON.stringify(currentData));
    let description = '';
    let rowsAffected = 0;
    
    switch(strategy) {
        case 'drop':
            const originalLength = newData.length;
            newData = newData.filter(row => {
                return Object.values(row).every(val => val !== null && val !== undefined);
            });
            rowsAffected = originalLength - newData.length;
            description = `Dropped ${rowsAffected} rows with missing values`;
            break;
            
        case 'mean':
            const numericColumns = ['age', 'salary', 'experience'];
            numericColumns.forEach(col => {
                const values = newData.filter(row => row[col] !== null && row[col] !== undefined).map(row => row[col]);
                if (values.length > 0) {
                    const mean = Math.round(values.reduce((a, b) => a + b, 0) / values.length);
                    newData.forEach(row => {
                        if (row[col] === null || row[col] === undefined) {
                            row[col] = mean;
                            rowsAffected++;
                        }
                    });
                }
            });
            description = `Filled ${rowsAffected} missing numeric values with column means`;
            break;
            
        case 'mode':
            const categoricalColumns = ['department'];
            categoricalColumns.forEach(col => {
                const values = newData.filter(row => row[col] !== null && row[col] !== undefined).map(row => row[col]);
                if (values.length > 0) {
                    // Find mode (most frequent value)
                    const frequency = {};
                    values.forEach(val => frequency[val] = (frequency[val] || 0) + 1);
                    const mode = Object.keys(frequency).reduce((a, b) => frequency[a] > frequency[b] ? a : b);
                    
                    newData.forEach(row => {
                        if (row[col] === null || row[col] === undefined) {
                            row[col] = mode;
                            rowsAffected++;
                        }
                    });
                }
            });
            description = `Filled ${rowsAffected} missing categorical values with column modes`;
            break;
            
        case 'median':
            const numCols = ['age', 'salary', 'experience'];
            numCols.forEach(col => {
                const values = newData.filter(row => row[col] !== null && row[col] !== undefined)
                                   .map(row => row[col])
                                   .sort((a, b) => a - b);
                if (values.length > 0) {
                    const median = values[Math.floor(values.length / 2)];
                    newData.forEach(row => {
                        if (row[col] === null || row[col] === undefined) {
                            row[col] = median;
                            rowsAffected++;
                        }
                    });
                }
            });
            description = `Filled ${rowsAffected} missing numeric values with column medians`;
            break;
    }
    
    currentData = newData;
    
    resultDiv.innerHTML = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle"></i> Strategy Applied Successfully</h6>
            <p><strong>Action:</strong> ${description}</p>
            <p><strong>Dataset Size:</strong> ${newData.length} rows</p>
            <button onclick="displayDataTable()" class="btn btn-primary btn-sm">View Updated Data</button>
        </div>
    `;
}
</script>
{% endblock %}
